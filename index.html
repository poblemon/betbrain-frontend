<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetBrain IA - Chatbot Experto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes slideIn {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .chat-bubble { animation: slideIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
    <div id="root"></div>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script>
        const { useState, useEffect, useRef, createElement: e } = React;
        const API = 'https://betbrain-backend.onrender.com/api';
        
        function ChatBot({ matches }) {
            const [open, setOpen] = useState(false);
            const [messages, setMessages] = useState([
                { role: 'assistant', content: '¬°Hola! üëã Soy tu asistente BetBrain IA. ¬øEn qu√© puedo ayudarte hoy?' }
            ]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const messagesEnd = useRef(null);
            
            useEffect(() => {
                messagesEnd.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);
            
            async function sendMessage() {
                if (!input.trim()) return;
                
                const userMsg = { role: 'user', content: input };
                setMessages(prev => [...prev, userMsg]);
                const currentInput = input.trim().toLowerCase();
                setInput('');
                setLoading(true);
                
                // An√°lisis inteligente local mientras arreglamos Groq
                let response = '';
                
                try {
                    // Buscar equipo mencionado
                    const teamMentioned = matches.find(m => 
                        currentInput.includes(m.home.toLowerCase()) || 
                        currentInput.includes(m.away.toLowerCase())
                    );
                    
                    if (currentInput.includes('mejor') || currentInput.includes('recomiend')) {
                        // Encontrar el mejor pick
                        const bestMatch = matches.reduce((best, m) => {
                            const homeEdge = ((m.probs.home / ((1/m.odds.home)*100)) - 1) * 100;
                            const bestEdge = best ? ((best.probs.home / ((1/best.odds.home)*100)) - 1) * 100 : 0;
                            return homeEdge > bestEdge ? m : best;
                        }, null);
                        
                        if (bestMatch) {
                            const homeEdge = ((bestMatch.probs.home / ((1/bestMatch.odds.home)*100)) - 1) * 100;
                            response = `üéØ **MEJOR PICK DE HOY**\n\n‚öΩ **${bestMatch.home} vs ${bestMatch.away}**\n${bestMatch.time} - ${bestMatch.date}\n\nüí∞ **Recomendaci√≥n:** Victoria ${bestMatch.home}\nüìä Cuota: ${bestMatch.odds.home}\n‚úÖ Probabilidad: ${bestMatch.probs.home.toFixed(0)}%\nüìà Ventaja: +${homeEdge.toFixed(1)}%\n\nüí° **Raz√≥n:** Este partido ofrece el mejor value seg√∫n mi an√°lisis. xG favorable (${bestMatch.probs.xGHome} vs ${bestMatch.probs.xGAway}) y cuota atractiva.`;
                        }
                    }
                    else if (currentInput.includes('ganar') && currentInput.match(/\d+/)) {
                        // Calcular combinada para ganar X
                        const amount = parseInt(currentInput.match(/\d+/)[0]);
                        const topPicks = matches.slice(0, 3);
                        const totalOdds = topPicks.reduce((acc, m) => acc * m.odds.home, 1);
                        const stake = (amount / totalOdds).toFixed(2);
                        
                        response = `üí∞ **COMBINADA PARA GANAR ‚Ç¨${amount}**\n\nüéØ Apuesta necesaria: ‚Ç¨${stake}\nüìä Cuota total: ${totalOdds.toFixed(2)}\n\n**Picks seleccionados:**\n${topPicks.map((m, i) => `${i+1}. ${m.home} vs ${m.away} - Victoria Local (${m.odds.home})`).join('\n')}\n\n‚ö†Ô∏è Riesgo: Medio\n‚úÖ Probabilidad combinada: ${(topPicks.reduce((acc, m) => acc * (m.probs.home/100), 1) * 100).toFixed(0)}%`;
                    }
                    else if (teamMentioned) {
                        // An√°lisis espec√≠fico del equipo
                        const isHome = currentInput.includes(teamMentioned.home.toLowerCase());
                        const team = isHome ? teamMentioned.home : teamMentioned.away;
                        const odds = isHome ? teamMentioned.odds.home : teamMentioned.odds.away;
                        const prob = isHome ? teamMentioned.probs.home : teamMentioned.probs.away;
                        const xG = isHome ? teamMentioned.probs.xGHome : teamMentioned.probs.xGAway;
                        
                        const verdict = prob > 55 ? '‚úÖ S√≠, tiene buenas chances' : prob > 40 ? '‚ö†Ô∏è Es posible, pero arriesgado' : '‚ùå No es probable';
                        
                        response = `‚öΩ **AN√ÅLISIS: ${team}**\n\n${verdict}\n\nüìä **Estad√≠sticas:**\n‚Ä¢ Probabilidad de ganar: ${prob.toFixed(0)}%\n‚Ä¢ Cuota: ${odds}\n‚Ä¢ xG esperado: ${xG}\n‚Ä¢ Over 2.5: ${teamMentioned.probs.over25}%\n‚Ä¢ BTTS: ${teamMentioned.probs.btts}%\n\nüí° ${prob > 55 ? 'Recomiendo apostar a su victoria' : prob > 40 ? 'Considera apostarlo en combinada' : 'No lo recomiendo como apuesta individual'}`;
                    }
                    else if (currentInput.includes('combinada')) {
                        const safePicks = matches.filter(m => m.probs.home > 60).slice(0, 3);
                        const totalOdds = safePicks.reduce((acc, m) => acc * m.odds.home, 1);
                        
                        response = `üéØ **COMBINADA SEGURA**\n\nüìä Cuota total: ${totalOdds.toFixed(2)}\n‚úÖ Probabilidad: ${(safePicks.reduce((acc, m) => acc * (m.probs.home/100), 1) * 100).toFixed(0)}%\n\n**Selecci√≥n:**\n${safePicks.map((m, i) => `${i+1}. ${m.home} vs ${m.away}\n   Victoria ${m.home} (${m.odds.home})\n   Prob: ${m.probs.home.toFixed(0)}%`).join('\n\n')}\n\nüí∞ Con ‚Ç¨10 ganar√≠as: ‚Ç¨${(10 * totalOdds).toFixed(2)}`;
                    }
                    else if (currentInput.includes('hola') || currentInput.includes('buenos')) {
                        response = `¬°Hola! üëã Soy tu asistente BetBrain IA.\n\nTengo ${matches.length} partidos analizados para ti.\n\n¬øQu√© te gustar√≠a saber?\n‚Ä¢ "Dame el mejor pick"\n‚Ä¢ "¬øGanar√° [equipo]?"\n‚Ä¢ "Quiero ganar ‚Ç¨100"\n‚Ä¢ "Hazme una combinada"`;
                    }
                    else {
                        response = `Entiendo que quieres informaci√≥n sobre apuestas.\n\nActualmente tengo ${matches.length} partidos disponibles.\n\n¬øPodr√≠as ser m√°s espec√≠fico?\nEjemplo:\n‚Ä¢ "¬øGanar√° el Liverpool?"\n‚Ä¢ "Dame el mejor pick"\n‚Ä¢ "Hazme una combinada segura"`;
                    }
                    
                    // Si no hay respuesta, intentar con Groq
                    if (!response) {
                        const enrichedMatches = matches.map(m => ({
                            home: m.home,
                            away: m.away,
                            time: m.time,
                            odds: m.odds,
                            xGHome: m.probs?.xGHome,
                            xGAway: m.probs?.xGAway,
                            over25: m.probs?.over25,
                            btts: m.probs?.btts,
                            homeProb: m.probs?.home?.toFixed(1),
                            awayProb: m.probs?.away?.toFixed(1)
                        }));
                        
                        const res = await fetch(`${API}/chatbot`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                message: currentInput,
                                history: messages,
                                matches: enrichedMatches
                            })
                        });
                        
                        if (res.ok) {
                            const data = await res.json();
                            response = data.response;
                        }
                    }
                    
                    setMessages(prev => [...prev, { 
                        role: 'assistant', 
                        content: response
                    }]);
                    
                } catch (err) {
                    console.error('Chatbot error:', err);
                    setMessages(prev => [...prev, { 
                        role: 'assistant', 
                        content: `üìä Tengo ${matches.length} partidos analizados.\n\n¬øQu√© necesitas?\n‚Ä¢ Pregunta por un equipo espec√≠fico\n‚Ä¢ "Dame el mejor pick"\n‚Ä¢ "Quiero ganar ‚Ç¨X"` 
                    }]);
                }
                setLoading(false);
            }
            
            function quickAction(action) {
                setInput(action);
                setTimeout(() => sendMessage(), 100);
            }
            
            return e('div', { className: 'fixed bottom-6 right-6 z-50' },
                // Bot√≥n flotante
                !open && e('button', {
                    onClick: () => setOpen(true),
                    className: 'bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-full w-16 h-16 shadow-2xl hover:scale-110 transition flex items-center justify-center text-2xl'
                }, 'ü§ñ'),
                
                // Ventana de chat
                open && e('div', { className: 'bg-slate-800 rounded-2xl shadow-2xl w-96 h-[600px] flex flex-col border border-purple-500/30' },
                    // Header
                    e('div', { className: 'bg-gradient-to-r from-purple-600 to-pink-600 p-4 rounded-t-2xl flex justify-between items-center' },
                        e('div', { className: 'flex items-center gap-3' },
                            e('div', { className: 'text-2xl' }, 'ü§ñ'),
                            e('div', {},
                                e('div', { className: 'font-bold' }, 'BetBrain IA'),
                                e('div', { className: 'text-xs opacity-80' }, 'Asistente experto')
                            )
                        ),
                        e('button', {
                            onClick: () => setOpen(false),
                            className: 'text-white/80 hover:text-white text-2xl'
                        }, '√ó')
                    ),
                    
                    // Mensajes
                    e('div', { className: 'flex-1 overflow-y-auto p-4 space-y-4' },
                        messages.map((msg, i) =>
                            e('div', {
                                key: i,
                                className: `chat-bubble flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`
                            },
                                e('div', {
                                    className: `max-w-[80%] rounded-2xl px-4 py-3 ${
                                        msg.role === 'user' 
                                            ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white' 
                                            : 'bg-slate-700 text-gray-100'
                                    }`
                                }, msg.content)
                            )
                        ),
                        loading && e('div', { className: 'flex justify-start' },
                            e('div', { className: 'bg-slate-700 rounded-2xl px-4 py-3' },
                                e('div', { className: 'flex gap-1' },
                                    [1,2,3].map(i => e('div', {
                                        key: i,
                                        className: 'w-2 h-2 bg-purple-400 rounded-full animate-bounce',
                                        style: { animationDelay: `${i * 0.1}s` }
                                    }))
                                )
                            )
                        ),
                        e('div', { ref: messagesEnd })
                    ),
                    
                    // Acciones r√°pidas
                    messages.length <= 1 && e('div', { className: 'px-4 pb-2 flex flex-wrap gap-2' },
                        ['Dame los mejores picks', 'Quiero ganar ‚Ç¨100', 'Crea una combinada'].map(action =>
                            e('button', {
                                key: action,
                                onClick: () => quickAction(action),
                                className: 'text-xs bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded-full transition'
                            }, action)
                        )
                    ),
                    
                    // Input
                    e('div', { className: 'p-4 border-t border-slate-700' },
                        e('div', { className: 'flex gap-2' },
                            e('input', {
                                type: 'text',
                                value: input,
                                onChange: ev => setInput(ev.target.value),
                                onKeyPress: ev => ev.key === 'Enter' && sendMessage(),
                                placeholder: 'Escribe tu pregunta...',
                                className: 'flex-1 bg-slate-700 rounded-full px-4 py-2 outline-none focus:ring-2 focus:ring-purple-500 text-white placeholder-gray-400'
                            }),
                            e('button', {
                                onClick: sendMessage,
                                disabled: !input.trim(),
                                className: 'bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-full w-10 h-10 flex items-center justify-center disabled:opacity-50 hover:scale-105 transition'
                            }, '‚û§')
                        )
                    )
                )
            );
        }
        
        function App() {
            const [leagues] = useState([
                { id: 2021, name: 'Premier League', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø' },
                { id: 2014, name: 'LaLiga', flag: 'üá™üá∏' },
                { id: 2019, name: 'Serie A', flag: 'üáÆüáπ' },
                { id: 2002, name: 'Bundesliga', flag: 'üá©üá™' }
            ]);
            const [selected, setSelected] = useState(null);
            const [matches, setMatches] = useState([]);
            const [loading, setLoading] = useState(false);
            
            async function loadMatches(league) {
                setLoading(true);
                setSelected(league);
                try {
                    const [matchRes, standRes] = await Promise.all([
                        fetch(`${API}/matches/${league.id}`),
                        fetch(`${API}/standings/${league.id}`)
                    ]);
                    const matchData = await matchRes.json();
                    const standData = await standRes.json();
                    const standings = standData.standings?.[0]?.table || [];
                    
                    const processed = (matchData.matches || []).slice(0, 10).map(m => {
                        const homeTeam = standings.find(t => t.team.id === m.homeTeam.id);
                        const awayTeam = standings.find(t => t.team.id === m.awayTeam.id);
                        
                        // Calcular probabilidades
                        const homeFormScore = homeTeam?.form?.split(',').filter(r => r === 'W').length / 5 || 0.5;
                        const awayFormScore = awayTeam?.form?.split(',').filter(r => r === 'W').length / 5 || 0.5;
                        const homeGoalsAvg = homeTeam ? homeTeam.goalsFor / homeTeam.playedGames : 1.5;
                        const awayGoalsAvg = awayTeam ? awayTeam.goalsFor / awayTeam.playedGames : 1.5;
                        
                        const xGHome = (homeGoalsAvg * 1.2).toFixed(2);
                        const xGAway = (awayGoalsAvg * 0.9).toFixed(2);
                        const totalXG = parseFloat(xGHome) + parseFloat(xGAway);
                        
                        const homeWinProb = (homeFormScore * 0.4 + (homeGoalsAvg / (homeGoalsAvg + awayGoalsAvg)) * 0.6) * 100;
                        const awayWinProb = (awayFormScore * 0.4 + (awayGoalsAvg / (homeGoalsAvg + awayGoalsAvg)) * 0.6) * 100;
                        
                        return {
                            id: m.id,
                            home: m.homeTeam.shortName || m.homeTeam.name,
                            away: m.awayTeam.shortName || m.awayTeam.name,
                            time: new Date(m.utcDate).toLocaleTimeString('es', {hour:'2-digit',minute:'2-digit'}),
                            date: new Date(m.utcDate).toLocaleDateString('es'),
                            odds: m.odds || {home:2.1,draw:3.4,away:3.5},
                            probs: {
                                home: homeWinProb,
                                away: awayWinProb,
                                xGHome,
                                xGAway,
                                over25: Math.round(totalXG > 2.5 ? 65 + (totalXG - 2.5) * 10 : 45),
                                btts: Math.round(parseFloat(xGHome) > 0.8 && parseFloat(xGAway) > 0.8 ? 65 : 40)
                            }
                        };
                    });
                    setMatches(processed);
                } catch(err) {
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            }
            
            return e('div', { className: 'min-h-screen text-white p-6' },
                e('div', { className: 'max-w-7xl mx-auto' },
                    // Header
                    e('div', { className: 'text-center mb-8' },
                        e('h1', { className: 'text-5xl font-bold mb-2' }, '‚öΩ BetBrain IA'),
                        e('p', { className: 'text-gray-300' }, 'Asistente IA para an√°lisis de apuestas'),
                        e('div', { className: 'mt-3 flex items-center justify-center gap-2 text-sm' },
                            e('span', { className: 'bg-green-600/20 text-green-400 px-3 py-1 rounded-full' }, 'ü§ñ Chatbot IA activo'),
                            e('span', { className: 'bg-purple-600/20 text-purple-400 px-3 py-1 rounded-full' }, 'üìä An√°lisis en tiempo real')
                        )
                    ),
                    
                    // Ligas
                    e('div', { className: 'grid grid-cols-2 md:grid-cols-4 gap-4 mb-8' },
                        leagues.map(l => 
                            e('button', {
                                key: l.id,
                                onClick: () => loadMatches(l),
                                className: `p-4 rounded-xl transition ${selected?.id === l.id ? 'bg-gradient-to-r from-purple-600 to-pink-600 scale-105' : 'bg-slate-800/50 hover:bg-slate-700/50'}`
                            }, e('div', { className: 'text-3xl mb-2' }, l.flag), e('div', { className: 'text-sm' }, l.name))
                        )
                    ),
                    
                    // Partidos
                    loading ? e('div', { className: 'text-center py-20' },
                        e('div', { className: 'text-6xl mb-4' }, '‚öΩ'),
                        e('div', { className: 'text-xl text-purple-400' }, 'Cargando partidos...')
                    ) :
                    matches.length === 0 ? e('div', { className: 'text-center py-20' },
                        e('div', { className: 'text-6xl mb-4' }, 'üéØ'),
                        e('div', { className: 'text-xl text-gray-400' }, 'Selecciona una liga'),
                        e('div', { className: 'mt-4 text-purple-400' }, 'üí¨ O preg√∫ntale al chatbot ‚Üí')
                    ) :
                    e('div', { className: 'grid md:grid-cols-2 lg:grid-cols-3 gap-4' },
                        matches.map(m =>
                            e('div', {
                                key: m.id,
                                className: 'bg-slate-800/50 rounded-xl p-5 border border-purple-500/20 hover:border-purple-500/50 transition'
                            },
                                e('div', { className: 'text-purple-400 text-sm mb-3' }, m.time),
                                e('div', { className: 'grid grid-cols-3 gap-2 text-center' },
                                    e('div', {},
                                        e('div', { className: 'font-bold mb-1' }, m.home),
                                        e('div', { className: 'text-green-400 text-xl font-bold' }, m.odds.home)
                                    ),
                                    e('div', { className: 'text-gray-400' },
                                        e('div', { className: 'text-sm mb-1' }, 'Empate'),
                                        e('div', { className: 'text-lg font-bold' }, m.odds.draw)
                                    ),
                                    e('div', {},
                                        e('div', { className: 'font-bold mb-1' }, m.away),
                                        e('div', { className: 'text-green-400 text-xl font-bold' }, m.odds.away)
                                    )
                                )
                            )
                        )
                    )
                ),
                
                // Chatbot
                e(ChatBot, { matches })
            );
        }
        
        ReactDOM.createRoot(document.getElementById('root')).render(e(App));
    </script>
</body>
</html>
