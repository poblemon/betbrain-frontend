<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetBrain IA Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .neon-text { text-shadow: 0 0 10px rgba(168, 85, 247, 0.5); }
        .prob-bar { transition: width 1s ease-out; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    </style>
</head>
<body class="bg-slate-950 text-white overflow-x-hidden">
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    
    <script>
        const { useState, useEffect, useRef, createElement: e } = React;
        const API_URL = 'http://localhost:8000/api'; // Cambia esto a tu URL de Render

        // --- COMPONENTES UI ---

        const ProbabilityBar = ({ label, percent, color }) => e('div', { className: 'mb-2' },
            e('div', { className: 'flex justify-between text-xs mb-1 text-gray-300' },
                e('span', {}, label),
                e('span', { className: 'font-bold' }, `${percent}%`)
            ),
            e('div', { className: 'h-2 bg-slate-700 rounded-full overflow-hidden' },
                e('div', { 
                    className: `h-full ${color} prob-bar`, 
                    style: { width: `${percent}%` } 
                })
            )
        );

        const ModalStats = ({ match, onClose }) => {
            if (!match) return null;
            return e('div', { className: 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm' },
                e('div', { className: 'bg-slate-900 w-full max-w-2xl rounded-2xl border border-purple-500/30 p-6 shadow-2xl animate-in fade-in zoom-in' },
                    e('div', { className: 'flex justify-between items-start mb-6' },
                        e('h2', { className: 'text-2xl font-bold' }, 
                            e('span', { className: 'text-purple-400' }, 'AnÃ¡lisis IA: '),
                            `${match.teams.home} vs ${match.teams.away}`
                        ),
                        e('button', { onClick: onClose, className: 'text-gray-400 hover:text-white' }, 'âœ•')
                    ),
                    e('div', { className: 'grid md:grid-cols-2 gap-8' },
                        e('div', { className: 'space-y-4' },
                            e('h3', { className: 'font-bold text-gray-400 uppercase text-xs tracking-wider' }, 'Probabilidades MatemÃ¡ticas'),
                            e(ProbabilityBar, { label: `Victoria ${match.teams.home}`, percent: match.probabilities.home_win, color: 'bg-green-500' }),
                            e(ProbabilityBar, { label: 'Empate', percent: match.probabilities.draw, color: 'bg-yellow-500' }),
                            e(ProbabilityBar, { label: `Victoria ${match.teams.away}`, percent: match.probabilities.away_win, color: 'bg-red-500' }),
                            e('div', { className: 'my-4 border-t border-slate-700' }),
                            e(ProbabilityBar, { label: 'MÃ¡s de 2.5 Goles', percent: match.probabilities.over_2_5, color: 'bg-blue-500' }),
                            e(ProbabilityBar, { label: 'Ambos Anotan (BTTS)', percent: match.probabilities.btts, color: 'bg-orange-500' })
                        ),
                        e('div', { className: 'space-y-4' },
                            e('h3', { className: 'font-bold text-gray-400 uppercase text-xs tracking-wider' }, 'MÃ©tricas Avanzadas'),
                            e('div', { className: 'grid grid-cols-2 gap-4' },
                                e('div', { className: 'bg-slate-800 p-3 rounded-xl text-center' },
                                    e('div', { className: 'text-xs text-gray-400' }, 'xG Local'),
                                    e('div', { className: 'text-xl font-bold text-green-400' }, match.probabilities.xg_home)
                                ),
                                e('div', { className: 'bg-slate-800 p-3 rounded-xl text-center' },
                                    e('div', { className: 'text-xs text-gray-400' }, 'xG Visita'),
                                    e('div', { className: 'text-xl font-bold text-red-400' }, match.probabilities.xg_away)
                                )
                            ),
                            e('div', { className: 'bg-purple-900/20 border border-purple-500/30 p-4 rounded-xl' },
                                e('div', { className: 'flex items-center gap-2 mb-2 text-purple-400' },
                                    e('span', {}, 'ðŸ¤–'), e('span', { className: 'font-bold' }, 'BetBrain Insight')
                                ),
                                e('p', { className: 'text-sm text-gray-300' }, 
                                    match.insights.length > 0 ? match.insights[0] : "Partido muy equilibrado, riesgo alto."
                                )
                            )
                        )
                    )
                )
            );
        };

        const BetSlip = ({ bets, onRemove, onClear }) => {
            const totalOdds = bets.reduce((acc, bet) => acc * bet.odd, 1);
            const [stake, setStake] = useState(10);

            if (bets.length === 0) return null;

            return e('div', { className: 'fixed bottom-24 right-6 w-80 bg-slate-800 rounded-xl shadow-2xl border border-purple-500/30 overflow-hidden z-40' },
                e('div', { className: 'bg-purple-700 p-3 flex justify-between items-center' },
                    e('span', { className: 'font-bold' }, `CupÃ³n (${bets.length})`),
                    e('button', { onClick: onClear, className: 'text-xs text-white/70 hover:text-white' }, 'Limpiar')
                ),
                e('div', { className: 'max-h-60 overflow-y-auto p-2' },
                    bets.map((bet, i) => 
                        e('div', { key: i, className: 'bg-slate-700/50 p-2 rounded mb-2 flex justify-between items-center text-sm' },
                            e('div', {},
                                e('div', { className: 'font-bold' }, bet.selection),
                                e('div', { className: 'text-xs text-gray-400' }, `${bet.match} @ ${bet.odd}`)
                            ),
                            e('button', { onClick: () => onRemove(i), className: 'text-red-400 hover:text-red-300' }, 'Ã—')
                        )
                    )
                ),
                e('div', { className: 'p-4 bg-slate-900 border-t border-slate-700' },
                    e('div', { className: 'flex justify-between mb-2 text-sm' },
                        e('span', {}, 'Cuota Total:'),
                        e('span', { className: 'text-yellow-400 font-bold' }, totalOdds.toFixed(2))
                    ),
                    e('div', { className: 'flex items-center gap-2 mb-3' },
                        e('span', { className: 'text-sm' }, 'Apuesta: $'),
                        e('input', { 
                            type: 'number', value: stake, onChange: e => setStake(e.target.value),
                            className: 'w-20 bg-slate-700 rounded px-2 py-1 text-right outline-none focus:ring-1 ring-purple-500'
                        })
                    ),
                    e('div', { className: 'flex justify-between font-bold text-green-400 text-lg mb-3' },
                        e('span', {}, 'Posible Retorno:'),
                        e('span', {}, `$${(stake * totalOdds).toFixed(2)}`)
                    ),
                    e('button', { className: 'w-full bg-gradient-to-r from-green-600 to-green-500 py-2 rounded-lg font-bold hover:shadow-lg transition' }, 'APOSTAR AHORA')
                )
            );
        };

        const ChatInterface = ({ matches }) => {
            const [open, setOpen] = useState(false);
            const [input, setInput] = useState('');
            const [msgs, setMsgs] = useState([{role:'ai', content:'Soy BetBrain. Analizo probabilidades matemÃ¡ticas. Â¿CuÃ¡nto quieres ganar hoy?'}]);
            const [loading, setLoading] = useState(false);
            
            const send = async () => {
                if(!input.trim()) return;
                const newMsgs = [...msgs, {role:'user', content:input}];
                setMsgs(newMsgs);
                setInput('');
                setLoading(true);

                try {
                    const res = await fetch(`${API_URL}/chatbot`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ message: input, history: newMsgs, matches })
                    });
                    const data = await res.json();
                    setMsgs([...newMsgs, {role:'ai', content: data.response}]);
                } catch(e) {
                    setMsgs([...newMsgs, {role:'ai', content: "Error de conexiÃ³n. Intenta de nuevo."}]);
                }
                setLoading(false);
            };

            return e('div', { className: 'fixed bottom-6 right-6 z-50' },
                !open && e('button', { 
                    onClick: () => setOpen(true),
                    className: 'w-16 h-16 rounded-full bg-gradient-to-tr from-purple-600 to-blue-600 text-3xl shadow-lg hover:scale-110 transition flex items-center justify-center'
                }, 'ðŸ§ '),
                open && e('div', { className: 'w-96 h-[500px] bg-slate-900 rounded-2xl shadow-2xl flex flex-col border border-purple-500/40 overflow-hidden' },
                    e('div', { className: 'p-4 bg-slate-800 flex justify-between items-center border-b border-slate-700' },
                        e('div', { className: 'font-bold flex items-center gap-2' }, 'ðŸ§  BetBrain IA', e('span', { className: 'text-xs bg-green-900 text-green-300 px-2 py-0.5 rounded-full' }, 'Online')),
                        e('button', { onClick: () => setOpen(false) }, 'âœ•')
                    ),
                    e('div', { className: 'flex-1 overflow-y-auto p-4 space-y-4' },
                        msgs.map((m, i) => e('div', { 
                            key: i, 
                            className: `max-w-[85%] p-3 rounded-xl text-sm ${m.role === 'user' ? 'bg-purple-600 ml-auto text-white' : 'bg-slate-700 mr-auto text-gray-200'}`
                        }, m.content)),
                        loading && e('div', { className: 'text-xs text-gray-500 animate-pulse' }, 'Analizando mercados...')
                    ),
                    e('div', { className: 'p-3 bg-slate-800 border-t border-slate-700 flex gap-2' },
                        e('input', { 
                            value: input, onChange: e => setInput(e.target.value),
                            onKeyDown: e => e.key === 'Enter' && send(),
                            className: 'flex-1 bg-slate-900 rounded-lg px-3 py-2 text-sm outline-none focus:ring-1 ring-purple-500',
                            placeholder: 'Pregunta sobre apuestas...'
                        }),
                        e('button', { onClick: send, className: 'bg-purple-600 px-4 rounded-lg hover:bg-purple-500' }, 'âž¤')
                    )
                )
            );
        };

        const App = () => {
            const [matches, setMatches] = useState([]);
            const [slip, setSlip] = useState([]);
            const [selectedMatch, setSelectedMatch] = useState(null);
            const [loading, setLoading] = useState(false);
            const [league, setLeague] = useState(2021); // Premier por defecto

            useEffect(() => {
                setLoading(true);
                fetch(`${API_URL}/matches/${league}`)
                    .then(r => r.json())
                    .then(d => { setMatches(d.matches || []); setLoading(false); })
                    .catch(e => setLoading(false));
            }, [league]);

            const addToSlip = (selection, odd, matchName) => {
                setSlip([...slip, { selection, odd, match: matchName }]);
            };

            return e('div', { className: 'min-h-screen pb-20' },
                // Navbar
                e('div', { className: 'glass sticky top-0 z-30 px-6 py-4 flex justify-between items-center mb-8' },
                    e('h1', { className: 'text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-600' }, 'BetBrain IA'),
                    e('div', { className: 'flex gap-2' },
                        e('select', { 
                            value: league, onChange: e => setLeague(e.target.value),
                            className: 'bg-slate-800 rounded-lg px-3 py-1 text-sm outline-none border border-slate-600'
                        }, 
                            e('option', { value: 2021 }, 'ðŸ‡¬ðŸ‡§ Premier League'),
                            e('option', { value: 2014 }, 'ðŸ‡ªðŸ‡¸ La Liga'),
                            e('option', { value: 2019 }, 'ðŸ‡®ðŸ‡¹ Serie A'),
                            e('option', { value: 2002 }, 'ðŸ‡©ðŸ‡ª Bundesliga')
                        )
                    )
                ),

                // Grid de Partidos
                e('div', { className: 'max-w-7xl mx-auto px-4' },
                    loading 
                    ? e('div', { className: 'flex justify-center items-center h-64' }, 
                        e('div', { className: 'animate-spin rounded-full h-12 w-12 border-b-2 border-purple-500' })
                      )
                    : e('div', { className: 'grid md:grid-cols-2 lg:grid-cols-3 gap-6' },
                        matches.map(m => e('div', { 
                            key: m.id, 
                            className: 'bg-slate-800 rounded-2xl p-5 border border-slate-700 hover:border-purple-500 transition shadow-lg group relative'
                        },
                            // Badge de Insight
                            m.insights.length > 0 && e('div', { className: 'absolute -top-3 -right-3 bg-gradient-to-r from-green-500 to-emerald-600 text-xs font-bold px-3 py-1 rounded-full shadow-lg z-10 animate-bounce' }, 'ðŸ’Ž VALUE'),
                            
                            // Info Equipos
                            e('div', { className: 'text-center mb-4 cursor-pointer', onClick: () => setSelectedMatch(m) },
                                e('div', { className: 'text-xs text-gray-400 mb-2' }, new Date(m.time).toLocaleString()),
                                e('div', { className: 'flex justify-between items-center text-xl font-bold mb-4' },
                                    e('span', {}, m.teams.home),
                                    e('span', { className: 'text-sm text-purple-400 bg-purple-900/30 px-2 py-1 rounded' }, 'VS'),
                                    e('span', {}, m.teams.away)
                                ),
                                // Barra rÃ¡pida de probabilidad
                                e('div', { className: 'h-1.5 w-full bg-slate-700 rounded-full flex overflow-hidden' },
                                    e('div', { className: 'bg-green-500', style: { width: `${m.probabilities.home_win}%` } }),
                                    e('div', { className: 'bg-gray-500', style: { width: `${m.probabilities.draw}%` } }),
                                    e('div', { className: 'bg-red-500', style: { width: `${m.probabilities.away_win}%` } })
                                )
                            ),
                            
                            // Botones de Cuotas
                            e('div', { className: 'grid grid-cols-3 gap-2' },
                                e('button', { 
                                    onClick: () => addToSlip(m.teams.home, m.odds.home, `${m.teams.home} vs ${m.teams.away}`),
                                    className: 'bg-slate-700 hover:bg-slate-600 py-2 rounded-lg transition text-center'
                                },
                                    e('div', { className: 'text-xs text-gray-400' }, '1'),
                                    e('div', { className: 'font-bold text-green-400' }, m.odds.home)
                                ),
                                e('button', { 
                                    onClick: () => addToSlip('Empate', m.odds.draw, `${m.teams.home} vs ${m.teams.away}`),
                                    className: 'bg-slate-700 hover:bg-slate-600 py-2 rounded-lg transition text-center'
                                },
                                    e('div', { className: 'text-xs text-gray-400' }, 'X'),
                                    e('div', { className: 'font-bold' }, m.odds.draw)
                                ),
                                e('button', { 
                                    onClick: () => addToSlip(m.teams.away, m.odds.away, `${m.teams.home} vs ${m.teams.away}`),
                                    className: 'bg-slate-700 hover:bg-slate-600 py-2 rounded-lg transition text-center'
                                },
                                    e('div', { className: 'text-xs text-gray-400' }, '2'),
                                    e('div', { className: 'font-bold text-red-400' }, m.odds.away)
                                )
                            ),
                            
                            // BotÃ³n AnÃ¡lisis
                            e('button', { 
                                onClick: () => setSelectedMatch(m),
                                className: 'w-full mt-4 text-sm text-purple-400 border border-purple-500/30 py-2 rounded-lg hover:bg-purple-500/10 transition' 
                            }, 'ðŸ“Š Ver AnÃ¡lisis Detallado')
                        ))
                    )
                ),

                // Modals y Widgets
                e(ModalStats, { match: selectedMatch, onClose: () => setSelectedMatch(null) }),
                e(BetSlip, { bets: slip, onRemove: i => setSlip(slip.filter((_, idx) => idx !== i)), onClear: () => setSlip([]) }),
                e(ChatInterface, { matches })
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(e(App));
    </script>
</body>
</html>
