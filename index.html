<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetBrain IA - Groq Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: white; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-5px); border-color: #a855f7; }
        .chat-anim { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script>
        const { useState, useEffect, useRef, createElement: e } = React;
        
        // ------------------------------------------------------------------
        // IMPORTANTE: CAMBIA ESTA URL POR LA DE TU PROYECTO EN RENDER
        // NO USES 'localhost' SI ESTAS EN VERCEL
        // Ejemplo: 'https://betbrain-backend.onrender.com'
        // ------------------------------------------------------------------
        const API_BASE = 'https://TU-URL-DE-RENDER-AQUI.onrender.com'; 
        // ------------------------------------------------------------------

        // Componente: Barra de Probabilidad
        const ProbBar = ({ label, val, color }) => e('div', { className: 'mb-2' },
            e('div', { className: 'flex justify-between text-xs mb-1 text-gray-400' },
                e('span', {}, label), e('span', { className: 'font-bold text-white' }, `${val}%`)
            ),
            e('div', { className: 'h-2 bg-slate-700 rounded-full overflow-hidden' },
                e('div', { className: `h-full ${color}`, style: { width: `${val}%` } })
            )
        );

        // Componente: Modal de Detalles
        const Modal = ({ match, onClose }) => e('div', { className: 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm' },
            e('div', { className: 'bg-slate-900 w-full max-w-lg rounded-2xl border border-purple-500 p-6 shadow-2xl chat-anim' },
                e('div', { className: 'flex justify-between mb-4' },
                    e('h3', { className: 'font-bold text-xl' }, `${match.teams.home} vs ${match.teams.away}`),
                    e('button', { onClick: onClose, className: 'text-gray-400 hover:text-white' }, 'âœ•')
                ),
                e('div', { className: 'space-y-4' },
                    e(ProbBar, { label: 'Victoria Local', val: match.probabilities.home_win, color: 'bg-green-500' }),
                    e(ProbBar, { label: 'Empate', val: match.probabilities.draw, color: 'bg-yellow-500' }),
                    e(ProbBar, { label: 'Victoria Visita', val: match.probabilities.away_win, color: 'bg-red-500' }),
                    e('div', { className: 'h-px bg-slate-700 my-4' }),
                    e(ProbBar, { label: 'Over 2.5 Goles', val: match.probabilities.over_2_5, color: 'bg-blue-500' }),
                    e(ProbBar, { label: 'Ambos Anotan', val: match.probabilities.btts, color: 'bg-orange-500' }),
                    e('div', { className: 'mt-4 bg-slate-800 p-3 rounded-lg' },
                        e('p', { className: 'text-sm text-purple-300' }, 
                            match.insights.length > 0 ? `ðŸ’¡ IA: ${match.insights[0]}` : "ðŸ’¡ IA: Partido muy cerrado, cuidado."
                        )
                    )
                )
            )
        );

        // Componente: Chatbot Flotante
        const Chatbot = ({ matches }) => {
            const [open, setOpen] = useState(false);
            const [msgs, setMsgs] = useState([{role:'assistant', content:'ðŸ¤– Hola, soy BetBrain con Llama 3. Â¿En quÃ© te ayudo?'}]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const bottomRef = useRef(null);

            useEffect(() => bottomRef.current?.scrollIntoView({behavior: 'smooth'}), [msgs]);

            const send = async () => {
                if(!input.trim()) return;
                const newMsgs = [...msgs, {role:'user', content:input}];
                setMsgs(newMsgs);
                setInput('');
                setLoading(true);

                try {
                    const res = await fetch(`${API_BASE}/api/chatbot`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ message: input, matches: matches, history: newMsgs })
                    });
                    const data = await res.json();
                    setMsgs([...newMsgs, {role:'assistant', content: data.response}]);
                } catch(e) {
                    setMsgs([...newMsgs, {role:'assistant', content: "âš ï¸ Error conectando con el cerebro de IA."}]);
                }
                setLoading(false);
            };

            return e('div', { className: 'fixed bottom-5 right-5 z-40 flex flex-col items-end' },
                open && e('div', { className: 'mb-4 w-80 h-96 bg-slate-800 rounded-2xl shadow-2xl border border-purple-500 flex flex-col overflow-hidden chat-anim' },
                    e('div', { className: 'bg-purple-900 p-3 flex justify-between items-center' },
                        e('span', { className: 'font-bold' }, 'ðŸ§  Chat IA'),
                        e('button', { onClick: () => setOpen(false) }, 'âœ•')
                    ),
                    e('div', { className: 'flex-1 overflow-y-auto p-3 space-y-3' },
                        msgs.map((m, i) => e('div', { key: i, className: `p-2 rounded-lg text-sm max-w-[85%] ${m.role==='user'?'bg-purple-600 ml-auto':'bg-slate-700 mr-auto'}` }, m.content)),
                        loading && e('div', { className: 'text-xs text-gray-500 animate-pulse' }, 'Pensando...'),
                        e('div', { ref: bottomRef })
                    ),
                    e('div', { className: 'p-2 border-t border-slate-700 flex gap-2' },
                        e('input', { 
                            className: 'flex-1 bg-slate-900 rounded px-2 text-sm outline-none', 
                            value: input, 
                            onChange: e=>setInput(e.target.value),
                            onKeyDown: e=>e.key==='Enter'&&send(),
                            placeholder: 'Pregunta...'
                        }),
                        e('button', { onClick: send, className: 'bg-purple-600 px-3 rounded' }, 'âž¤')
                    )
                ),
                !open && e('button', { 
                    onClick: () => setOpen(true),
                    className: 'w-14 h-14 bg-purple-600 rounded-full shadow-lg flex items-center justify-center text-2xl hover:bg-purple-500 transition'
                }, 'ðŸ¤–')
            );
        };

        // Componente: App Principal
        const App = () => {
            const [matches, setMatches] = useState([]);
            const [selected, setSelected] = useState(null);
            const [league, setLeague] = useState(2021);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                setLoading(true);
                // Asegurarse de quitar la barra al final si existe
                const cleanUrl = API_BASE.replace(/\/$/, "");
                fetch(`${cleanUrl}/api/matches/${league}`)
                    .then(r => r.json())
                    .then(d => { setMatches(d.matches || []); setLoading(false); })
                    .catch(e => { console.error(e); setLoading(false); });
            }, [league]);

            return e('div', { className: 'min-h-screen pb-20' },
                // Header
                e('div', { className: 'glass sticky top-0 z-30 px-6 py-4 flex justify-between items-center' },
                    e('h1', { className: 'text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600' }, 'BetBrain IA'),
                    e('select', { 
                        className: 'bg-slate-800 rounded px-3 py-1 text-sm border border-slate-600 outline-none',
                        value: league,
                        onChange: e => setLeague(e.target.value)
                    }, 
                        e('option', { value: 2021 }, 'ðŸ‡¬ðŸ‡§ Premier'),
                        e('option', { value: 2014 }, 'ðŸ‡ªðŸ‡¸ La Liga'),
                        e('option', { value: 2019 }, 'ðŸ‡®ðŸ‡¹ Serie A'),
                        e('option', { value: 2002 }, 'ðŸ‡©ðŸ‡ª Bundesliga')
                    )
                ),
                // Contenido
                e('div', { className: 'max-w-6xl mx-auto p-4' },
                    loading 
                    ? e('div', { className: 'text-center mt-20 text-purple-400 animate-pulse' }, 'Analizando mercado con IA...') 
                    : matches.length === 0 
                        ? e('div', { className: 'text-center mt-20 text-gray-500' }, 
                            e('div', { className: 'text-4xl mb-2' }, 'ðŸ˜´'),
                            'No hay partidos programados pronto o error de conexiÃ³n.'
                        )
                        : e('div', { className: 'grid md:grid-cols-2 lg:grid-cols-3 gap-6' },
                            matches.map(m => e('div', { 
                                key: m.id,
                                className: 'bg-slate-800 rounded-xl p-5 border border-slate-700 card-hover cursor-pointer relative',
                                onClick: () => setSelected(m)
                            },
                                m.insights.length > 0 && e('div', { className: 'absolute -top-2 -right-2 bg-green-600 text-xs px-2 py-1 rounded-full font-bold shadow' }, 'VALUE'),
                                e('div', { className: 'text-gray-400 text-xs mb-2' }, new Date(m.time).toLocaleString()),
                                e('div', { className: 'flex justify-between items-center font-bold text-lg mb-4' },
                                    e('span', {}, m.teams.home),
                                    e('span', { className: 'text-purple-500 text-sm' }, 'vs'),
                                    e('span', {}, m.teams.away)
                                ),
                                e('div', { className: 'grid grid-cols-3 gap-2 text-center text-sm' },
                                    e('div', { className: 'bg-slate-900 rounded py-2' }, 
                                        e('div', { className: 'text-gray-500 text-xs' }, '1'), 
                                        e('div', { className: 'text-green-400 font-bold' }, m.odds.home)
                                    ),
                                    e('div', { className: 'bg-slate-900 rounded py-2' }, 
                                        e('div', { className: 'text-gray-500 text-xs' }, 'X'), 
                                        e('div', { className: 'font-bold' }, m.odds.draw)
                                    ),
                                    e('div', { className: 'bg-slate-900 rounded py-2' }, 
                                        e('div', { className: 'text-gray-500 text-xs' }, '2'), 
                                        e('div', { className: 'text-red-400 font-bold' }, m.odds.away)
                                    )
                                ),
                                e('div', { className: 'mt-3 flex gap-1 h-1 bg-slate-700 rounded-full overflow-hidden' },
                                    e('div', { className: 'bg-green-500', style: { width: `${m.probabilities.home_win}%` } }),
                                    e('div', { className: 'bg-yellow-500', style: { width: `${m.probabilities.draw}%` } }),
                                    e('div', { className: 'bg-red-500', style: { width: `${m.probabilities.away_win}%` } })
                                )
                            ))
                        )
                ),
                selected && e(Modal, { match: selected, onClose: () => setSelected(null) }),
                e(Chatbot, { matches })
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(e(App));
    </script>
</body>
</html>
